(()=>{function K(t){let e={};return t.split(";").forEach(r=>{let[o,n]=r.split("=");e[o]=n}),e}var s={username:sessionStorage.getItem("username"),userId:sessionStorage.getItem("userId"),token:K(document.cookie).token||null,isLoggedIn:()=>s.username!==null&&s.userId!==null,init:()=>s.isLoggedIn()?(console.log("Already logged in"),Promise.resolve()):s.token===null?(console.log("No saved token found"),Promise.resolve()):m.request({method:"GET",url:"/api/verify-token"}).then(t=>{sessionStorage.setItem("username",t.username),sessionStorage.setItem("userId",t.user_id),s.username=t.username,s.userId=t.user_id}).catch(t=>{t.code==401&&s.clearCredentials()}).finally(m.redraw),saveLoginResults:({userId:t,username:e,token:r,remember:o})=>{sessionStorage.setItem("userId",t),sessionStorage.setItem("username",e),s.userId=t,s.username=e,s.token=r},logout:()=>s.request({method:"POST",url:"/api/logout"}).then(s.clearCredentials).catch(t=>{t.code==401?s.clearCredentials():console.log(t)}),clearCredentials:()=>{s.username=null,s.token=null,s.userId=null,sessionStorage.clear()},request:t=>m.request(t).catch(e=>{throw e.code==401?s.clearCredentials():e.code==500&&alert(e.response.message),e})},g={query:"",result:{},cache:{},isLoading:!0,performSearch:t=>{g.query=t,g.cache[t]?g.result=g.cache[t]:(g.isLoading=!0,m.redraw(),m.request({method:"GET",url:"/api/search/:query",params:{query:t}}).then(e=>{g.cache[t]=e.results,g.result=e.results}).catch(e=>{console.log("TODO",e)}).finally(()=>{g.isLoading=!1}))}},q={cache:{},cacheGet:(t,e,r)=>{let o=[t,e,r].join(",");return q.cache[o]||null},cacheSet:(t,e,r,o)=>{let n=[t,e,r].join(",");q.cache[n]=o},get:({site:t,titleId:e,chapterId:r})=>{let o=q.cacheGet(t,e,r);return o?Promise.resolve(o):s.request({method:"GET",url:"/api/chapter/:site/:titleId/:chapterId",params:{site:t,titleId:e,chapterId:r}}).then(n=>(q.cacheSet(t,e,r,n),n))}};var E={view:t=>m("h2.blink",[m("i.icon.icon-loader.spin")," loading..."])},y={view:t=>m("button",Object.assign({class:t.attrs.color||""},t.attrs),[t.attrs.icon?m(`i.icon.icon-${t.attrs.icon}`):null,t.attrs.text?m("span",t.attrs.text):null])},T={view:t=>m("div.utils--chapter",[m(m.route.Link,{href:`/m/${t.attrs.site}/${t.attrs.titleId}/${t.attrs.chapter.id}`,class:"touch-friendly"},[t.attrs.chapter.is_read?m("i.icon.icon-check-square.utils--chapter--read-icon"):null,m("span",P(t.attrs.chapter)),t.attrs.chapter.groups.map(e=>m("span.utils--chapter--group",j(e,20)))])])};function j(t,e){return t.length>e?`${t.substring(0,e)}...`:t}function P(t){let e="";return typeof t.num_major!="undefined"&&(e+=(t.volume?"Ch.":"Chapter ")+t.num_major),t.num_minor&&(e+="."+t.num_minor),t.volume&&(e+=" Vol. "+t.volume),t.name&&(e+=" - "+t.name),e}function F(t){let e=!1;return{view:r=>{let o;return s.isLoggedIn()?o=m("span.nav--greeting",[m("span",["Welcome, ",m("b",s.username)]),m(y,{text:e?" logging out":" logout",icon:"log-out",color:"red",title:"Log out",onclick:n=>{e=!0,m.redraw(),s.logout().then(()=>{m.route.set("/")}).finally(()=>{e=!1})},disabled:e?"disabled":null})]):o=m(m.route.Link,{class:"nav--link",href:"/a"},[m("i.icon.icon-log-in"),"login / register"]),m("nav",[m(m.route.Link,{class:"nav--logo",href:s.isLoggedIn()?"/f":"/"},[m("img.nav--logo--favicon",{src:"/static/favicon.svg",alt:"home"}),m("img.nav--logo--img",{src:"/static/pytaku.svg",alt:"home"})]),m("form.nav--search-form",{onsubmit:n=>{n.preventDefault(),m.route.set("/s/:query",{query:g.query})}},[m("input[placeholder=search manga title]",{onchange:n=>{g.query=n.target.value},value:g.query}),m(y,{color:"red",icon:"search",type:"submit"})]),o])}}}var V={view:t=>[m(F),t.children]},C=V;function Y(t){let e,r,o=!1,n,c,a,d,f,w,I=!1,p=!1;return{oncreate:b=>{document.title="Authentication - Pytaku"},view:b=>m("div.content.auth",[m("form.auth--form",{onsubmit:l=>{l.preventDefault(),n="",p=!0,m.redraw(),m.request({method:"POST",url:"/api/login",body:{username:e,password:r,remember:o}}).then(u=>{let L=u.user_id,_=u.token,i=e;s.saveLoginResults({userId:L,username:i,token:_,remember:o}),m.route.set("/f")}).catch(u=>{n=u.response.message}).finally(()=>{p=!1})}},[m("h1","Login"),m("input[placeholder=username][name=username][required]",{value:e,oninput:l=>{e=l.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:r,oninput:l=>{r=l.target.value}}),m("label[for=auth--remember].auth--checkbox-label",[m("input[type=checkbox][name=remember][id=auth--remember]",{checked:o,onchange:l=>{o=l.target.checked}})," Remember me"]),m(y,{type:"submit",disabled:p?"disabled":null,text:p?" Logging in...":" Log in",icon:"log-in",color:"blue"}),m("p.auth--form--error-message",n)]),m("form.auth--form",{onsubmit:l=>{if(l.preventDefault(),f="",m.redraw(),a!==d){f="Password confirmation didn't match!",w=!1;return}I=!0,m.redraw(),m.request({method:"POST",url:"/api/register",body:{username:c,password:a}}).then(u=>{w=!0,f=u.message,e=c,r=a}).catch(u=>{f=u.response.message,w=!1}).finally(()=>{I=!1})}},[m("h1","Register"),m("input[placeholder=username][name=username][required]",{value:c,oninput:l=>{c=l.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:a,oninput:l=>{a=l.target.value}}),m("input[placeholder=confirm password][name=confirm][type=password][required]",{value:d,oninput:l=>{d=l.target.value}}),m(y,{type:"submit",disabled:I?"disabled":null,text:I?" Registering...":" Register",icon:"user-plus",color:"green"}),m("p",{class:"auth--form--message-"+(w?"success":"error")},f)])])}}var D=Y;var z={oncreate:t=>{document.title="Pytaku"},view:t=>m("div.content",[m("p","Try searching for some manga title using the box above."),m("p","Logging in allows you to follow manga titles.")])},$=z;var H={view:t=>{let e=t.attrs.title,r=3;return m("div.follows--title"+(e.chapters.length===0?".empty":".non-empty"),[m("div",[m(m.route.Link,{href:`/m/${e.site}/${e.id}`,title:`${e.name} - ${e.site}`},[m("img.follows--cover",{src:e.thumbnail,alt:e.name})])]),m("div.follows--chapters",[e.chapters.length>r?m(m.route.Link,{href:`/m/${e.site}/${e.id}`,class:"follows--chapter follows--more"},`and ${e.chapters.length-r} more...`):"",e.chapters.slice(-r).map(o=>m(T,{site:e.site,titleId:e.id,chapter:o}))])])}};function W(t){let e=[],r=!1;return{oninit:()=>{r=!0,s.request({method:"GET",url:"/api/follows"}).then(o=>{e=o.titles}).catch(o=>{console.log(o)}).finally(()=>{r=!1})},oncreate:o=>{document.title="Stuff I follow - Pytaku"},view:o=>{let n="";return r?m("div.content",m(E)):e.length===0?m("div.content",[m("p","You're not following any title yet. Try searching for some."),m("p",["Migrating from Tachiyomi? ",m(m.route.Link,{href:"/i"},"Use the importer"),"!"])]):m("div.follows.content",[e.map(c=>m(H,{title:c}))])}}}var O=W;var J={oninit:t=>{document.title=`"${t.attrs.query}" search results`,g.performSearch(t.attrs.query)},view:t=>m("div.content",g.isLoading?m(E):g.result.map(({site:e,titles:r})=>m("div",[m("h1.search--site-heading",e),r?m("p.search--result-text",["Showing ",m("strong",r.length),` result${r.length>1?"s":""} for `,g.query]):m("p.search--result-text",`No results for "${g.query}"`),m("div.search--results",r.map(o=>m(m.route.Link,{class:"search--result",href:`/m/${e}/${o.id}`,title:o.name},[m("img",{src:o.thumbnail,alt:o.name}),m("span",j(o.name,50))])))])))},M=J;function Q(t){let e=!1,r=!1,o=!1,n=!1,c=null,a={},d,f,w;return{oninit:I=>{document.title="Manga",e=!0,m.redraw(),s.request({method:"GET",url:"/api/title/:site/:titleId",params:{site:I.attrs.site,titleId:I.attrs.titleId}}).then(p=>{a=p,document.title=a.name}).finally(()=>{e=!1})},view:I=>{if(!e&&s.isLoggedIn()){d=!0,f=!0,w=a.chapters.length;for(var p=a.chapters.length-1;p>=0;p--)a.chapters[p].is_read?(w===p+1&&(w=p),f=!1):d=!1}return m("div.content",e?m(E):[m("h1",a.name),m("div.title--details",[s.isLoggedIn()?[m(y,{icon:"bookmark",disabled:r?"disabled":null,text:r?"submitting...":a.is_following?"following":"follow",color:a.is_following?"red":"green",title:a.is_following?"Click to unfollow":"Click to follow",onclick:b=>{r=!0,m.redraw(),s.request({method:"POST",url:"/api/follow",body:{site:a.site,title_id:a.id,follow:!a.is_following}}).then(l=>{a.is_following=l.follow}).finally(()=>{r=!1})}}),m(y,{icon:"check-square",disabled:o||d?"disabled":null,text:o?"submitting...":d?"all read!":"read all",color:"green",title:d?null:"Click to mark all chapters as read",onclick:b=>{!window.confirm("Are you sure you want to read all chapters?")||(o=!0,m.redraw(),s.request({method:"POST",url:"/api/read",body:{read:a.chapters.filter(u=>!u.is_read).map(u=>({site:a.site,title_id:a.id,chapter_id:u.id}))}}).then(u=>{a.chapters.forEach(L=>{L.is_read=!0})}).finally(()=>{o=!1}))}}),m(y,{icon:"x-square",disabled:n||f?"disabled":null,text:n?"submitting...":f?"all unread!":"unread all",color:"white",title:f?null:"Click to mark all chapters as unread",onclick:b=>{!window.confirm("Are you sure you want to unread all chapters?")||(n=!0,m.redraw(),s.request({method:"POST",url:"/api/read",body:{unread:a.chapters.filter(u=>u.is_read).map(u=>({site:a.site,title_id:a.id,chapter_id:u.id}))}}).then(u=>{a.chapters.forEach(L=>{L.is_read=!1})}).finally(()=>{n=!1}))}})]:null,m("a.touch-friendly[title=Go to source site][target=_blank]",{href:a.source_url},[a.site,m("i.icon.icon-arrow-up-right")])]),m("img.title--cover[alt=cover]",{src:a.cover}),m(".title--descriptions",{},[a.descriptions.map(b=>m("p",a.descriptions_format==="html"?m.trust(b):b))]),a.chapters?a.chapters.map((b,l)=>m(".title--chapter-row",[l<w?m(y,{icon:c!==null&&l>=c?"loader":"chevrons-down",color:"green",title:"Mark all read up to this chapter",disabled:c!==null&&l>=c?"disabled":null,onclick:u=>{if(!window.confirm("Are you sure you want to mark all chapters up to this point as read?"))return;c=l,m.redraw();let _=a.chapters.slice(l).filter(i=>!i.is_read);if(_.length==0){c=null,m.redraw();return}s.request({method:"POST",url:"/api/read",body:{read:_.map(i=>({site:a.site,title_id:a.id,chapter_id:i.id}))}}).then(i=>{_.forEach(h=>{h.is_read=!0})}).finally(()=>{c=null})}}):null,m(T,{site:a.site,titleId:a.id,chapter:b})])):m("p","This one has no chapters.")])}}}var N=Q;var Z=43,X=45,ee=48,te=63,re=106,oe=107,se=104,ae=108,ie={view:()=>m("h2",[m("i.icon.icon-loader.spin")])},le={view:()=>m("h2",[m("i.icon.icon-loader")])},ne={view:t=>m(y,{text:"Errored. Try again?",color:"red",onclick:e=>{let{page:r}=t.attrs;r.status=x.LOADING,r.src=r.src.endsWith("?")?r.src.slice(0,-1):r.src+"?"}})},x={LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"};function R(t){let e;return{oninit:r=>{e=r.attrs.src},view:r=>m("img",{src:e,style:r.attrs.style,onload:r.attrs.onload,onerror:o=>{e===r.attrs.src&&r.attrs.altsrc!==null?e=r.attrs.altsrc:r.attrs.onerror(o)}})}}function me(t){let e=!1,r=!1,o={},n=[],c=[],a,d,f=null,w=null,I=[],p=100;function b(i){if(i.target.tagName!=="INPUT"){switch(i.keyCode){case Z:p<=85&&(p+=15);break;case X:p>15&&(p-=15);break;case ee:p=100;break;case te:window.alert(`Keyboard shortcuts:
    - to decrease page size
    + to increase page size (max 100%)
    0 (zero) to reset page size
    j to scroll down
    k to scroll up
    h to go to previous chapter
    l to go to next chapter`);break;case re:window.scrollBy({top:350,behavior:"smooth"});break;case oe:window.scrollBy({top:-350,behavior:"smooth"});break;case se:document.querySelector(".chapter--prev-button").click();break;case ae:document.querySelector(".chapter--next-button").click();break}m.redraw()}}function l(){if(c.length>0){let[i,h]=c.splice(0,1)[0];n.push({status:x.LOADING,src:i,altsrc:h})}else o.next_chapter&&f===null&&(f=q.get({site:a,titleId:d,chapterId:o.next_chapter.id}).then(i=>{console.log("Preloading next chapter:",P(i)),i.pages_alt.length>0?w=i.pages.map((h,v)=>[h,i.pages_alt[v]]):w=i.pages.map(h=>[h,null]),u(),u()}))}function u(){if(w!==null&&w.length>0){let[i,h]=w.splice(0,1)[0];I.push({src:i,altsrc:h})}}function L(i,h,v){return s.request({method:"POST",url:"/api/read",body:{read:[{site:i,title_id:h,chapter_id:v}]}})}function _(i,h,v){let S=v?`/m/${i}/${d}/${v.id}`:`/m/${i}/${d}`;return m("div.chapter--buttons",[h?m(m.route.Link,{class:"touch-friendly chapter--prev-button",href:`/m/${i}/${d}/${h.id}`},[m("i.icon.icon-chevrons-left"),m("span","prev")]):m(y,{class:"chapter--prev-button",text:"prev",icon:"chevrons-left",disabled:!0}),m(m.route.Link,{class:"touch-friendly",href:`/m/${i}/${d}`},[m("i.icon.icon-list"),m("span"," chapter list")]),m(m.route.Link,{class:"touch-friendly chapter--next-button"+(r?" disabled":""),href:S,disabled:r,onclick:A=>{s.isLoggedIn()&&(v?L(i,d,o.id):(A.preventDefault(),r=!0,m.redraw(),L(i,d,o.id).finally(()=>{r=!1,m.route.set(S)})))}},[m("span",v?"next":r?"finishing...":"finish"),r?null:m("i.icon.icon-"+(v?"chevrons-right":"check-circle"))])])}return{oncreate:i=>{document.addEventListener("keypress",b)},onremove:i=>{document.removeEventListener("keypress",b)},oninit:i=>{document.title="Manga chapter",a=i.attrs.site,d=i.attrs.titleId,e=!0,m.redraw(),q.get({site:i.attrs.site,titleId:i.attrs.titleId,chapterId:i.attrs.chapterId}).then(h=>{o=h,document.title=P(o),o.pages_alt.length>0?c=o.pages.map((v,S)=>[v,o.pages_alt[S]]):c=o.pages.map(v=>[v,null]),l(),l(),l()}).finally(()=>{e=!1})},view:i=>{if(e)return m("div.chapter.content",m(E));let{site:h,titleId:v}=i.attrs,S=o.prev_chapter,A=o.next_chapter;return m("div.chapter.content",[m("h1",P(o)),_(h,S,A),m("div",{class:"chapter--pages"+(o.is_webtoon?" chapter--webtoon":"")},[n.map((k,ce)=>m("div.chapter--page-container",{key:k.src,style:{width:`${p}%`,backgroundColor:p===100?"transparent":"#333"}},[m(R,{src:k.src,altsrc:k.altsrc,style:{display:k.status===x.SUCCEEDED?"inline":"none"},onload:B=>{k.status=x.SUCCEEDED,l()},onerror:B=>{k.status=x.FAILED,l()}}),k.status===x.LOADING?m(ie):null,k.status===x.FAILED?m("div",{style:{"margin-bottom":".5rem"}},m(ne,{page:k})):null])),c.map(()=>m(le))]),_(h,S,A),I.map(k=>m(R,{style:{display:"none"},onload:u,onerror:u,src:k.src,altsrc:k.altsrc}))])}}}var U=me;function ue(t){let e=null,r=null,o=!1;return{oninit:n=>{document.title="Import from Tachiyomi"},view:n=>m("div.content",[m("h1","Importing from Tachiyomi"),m("form[enctype=multipart/form-data]",{onsubmit:c=>{c.preventDefault();let a=document.getElementById("tachiyomi").files[0],d=new FormData;d.append("tachiyomi",a),o=!0,e=null,m.redraw(),s.request({method:"POST",url:"/api/import",body:d}).then(f=>{e=f.message,r=!0}).catch(f=>{e=f.response.message,r=!1}).finally(()=>{o=!1})}},[m("p",["Go to ",m("b","Settings > Backup > Create backup"),", then upload the generated json file here:"]),m("input[type=file][id=tachiyomi].importer--filepicker"),m("br"),m(y,{type:"submit",text:o?"uploading...":"upload",color:"green",icon:"upload",disabled:o?"disabled":null})]),m("p",{class:`importer--${r?"success":"failure"}`},e),r?m(m.route.Link,{href:"/f"},"See your following list here."):null])}}var G=ue;s.init().then(()=>{let t=document.getElementById("spa-root");m.route.prefix="",m.route(t,"/",{"/":{onmatch:()=>{if(s.isLoggedIn())m.route.set("/f",null,{replace:!0});else return $},render:e=>m(C,e)},"/a":{onmatch:()=>{if(s.isLoggedIn())m.route.set("/f",null,{replace:!0});else return D},render:e=>m(C,e)},"/f":{onmatch:()=>{if(s.isLoggedIn())return O;m.route.set("/a",null,{replace:!0})},render:e=>m(C,e)},"/s/:query":{render:e=>m(C,m(M,{query:e.attrs.query,key:e.attrs.query}))},"/m/:site/:titleId":{render:e=>m(C,m(N,{site:e.attrs.site,titleId:e.attrs.titleId}))},"/m/:site/:titleId/:chapterId":{render:e=>m(C,m(U,{site:e.attrs.site,titleId:e.attrs.titleId,chapterId:e.attrs.chapterId,key:e.attrs.chapterId}))},"/i":{onmatch:()=>{if(s.isLoggedIn())return G;m.route.set("/a",null,{replace:!0})},render:e=>m(C,e)}})});})();
//# sourceMappingURL=main.min.js.map
