<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Parallel computations &#8212; cogent3 2022.10.31a1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="../_static/require.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API" href="../api/index.html" />
    <link rel="prev" title="Phylogenetic reconstruction by least squares" href="phylo_by_ls.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Docs</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../install.html">Install</a></li>
                <li><a href="../draw/index.html">Gallery</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Sections <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../app/index.html">The <code class="docutils literal notranslate"><span class="pre">apps</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../cookbook/index.html">Cookbook</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Parallel computations</a><ul>
<li><a class="reference internal" href="#parallel-computation-on-a-single-computer">Parallel computation on a single computer</a><ul>
<li><a class="reference internal" href="#using-app-apply-to">Using <code class="docutils literal notranslate"><span class="pre">app.apply_to()</span></code></a></li>
<li><a class="reference internal" href="#directly-using-cogent3-util-parallel-map">Directly using <code class="docutils literal notranslate"><span class="pre">cogent3.util.parallel.map()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#parallel-computation-on-multiple-computers">Parallel computation on multiple computers</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="phylo_by_ls.html" title="Previous Chapter: Phylogenetic reconstruction by least squares"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Phylogenetic ...</span>
    </a>
  </li>
  <li>
    <a href="../api/index.html" title="Next Chapter: API"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">API &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <section id="parallel-computations">
<span id="parallel"></span><h1>Parallel computations<a class="headerlink" href="#parallel-computations" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">cogent3</span></code> supports parallel computation explicitly for the case where the same calculations need to be performed on many different data sets. As an example, consider the case of aligning all the one-to-one orthologs of protein coding genes sampled from 100 vertebrate species where the data for each gene is stored in a separate text file. These files are used as input for an alignment algorithm that will produce a corresponding output file. In other words, applying the alignment algorithm to <code class="docutils literal notranslate"><span class="pre">&quot;homologs1.fasta&quot;</span></code> produces <code class="docutils literal notranslate"><span class="pre">&quot;aligned-homologs1.fasta&quot;</span></code>.</p>
<p>We could perform the alignments in serial, one after the other, on one CPU core of a single computer. But what if we have 18,000 such files? If we had 18,000 CPUs then we could assign one alignment task to each file and be done in the same time as aligning a single file! This case is an example of “data parallelism” or “data level parallelism”.</p>
<p>There are multiple algorithmic approaches to solving parallel computation problems. The approach <code class="docutils literal notranslate"><span class="pre">cogent3</span></code> adopts is that of a master process and helper (or worker) processes. The master process splits the work up amongst the available CPU cores. Using our alignment example, the master process assigns sets of files to each worker CPU core. Each worker then performs the alignment step on its designated files and returns each alignment to the master process.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is not always faster to split tasks between processes. You should see a performance gain if the calculation time per task of the worker is significantly greater than the time it will take the master process to deal with the result – in our example, the time it takes to write the alignment to file.</p>
<p>While the alignment problem indicated above stipulated writing all results to separate files, this is not always a good idea. It can prove very inefficient if the individual alignment files are small. In such a case, storing the result in a single file (e.g. as a <code class="docutils literal notranslate"><span class="pre">sqlitedb</span></code> database) is better.</p>
</div>
<section id="parallel-computation-on-a-single-computer">
<h2>Parallel computation on a single computer<a class="headerlink" href="#parallel-computation-on-a-single-computer" title="Permalink to this headline">¶</a></h2>
<p>This is the simplest case to implement, requires no additional software installs and will work with standalone scripts or within Jupyter notebooks. For this use case, <code class="docutils literal notranslate"><span class="pre">cogent3.util.parallel</span></code> uses the Python standard library <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code> module.</p>
<section id="using-app-apply-to">
<h3>Using <code class="docutils literal notranslate"><span class="pre">app.apply_to()</span></code><a class="headerlink" href="#using-app-apply-to" title="Permalink to this headline">¶</a></h3>
<p>If you are using <code class="docutils literal notranslate"><span class="pre">cogent3</span></code> <a class="reference internal" href="../app/app-overview.html#apps"><span class="std std-ref">composable apps</span></a>, then the simplest approach is to use the <code class="docutils literal notranslate"><span class="pre">apply_to()</span></code> method. The conditions of parallel execution are controlled using the keyword arguments <code class="docutils literal notranslate"><span class="pre">parallel</span></code> and <code class="docutils literal notranslate"><span class="pre">par_kw</span></code>. The former indicates parallel execution is to be undertaken. The latter is how additional arguments are provided to <code class="docutils literal notranslate"><span class="pre">parallel.map()</span></code>. For instance, using 4 workers would be specified as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">apply_to</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">par_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are using mpi, set <code class="docutils literal notranslate"><span class="pre">par_kw=dict(max_workers=4,</span> <span class="pre">use_mpi=True)</span></code>.</p>
</div>
</section>
<section id="directly-using-cogent3-util-parallel-map">
<h3>Directly using <code class="docutils literal notranslate"><span class="pre">cogent3.util.parallel.map()</span></code><a class="headerlink" href="#directly-using-cogent3-util-parallel-map" title="Permalink to this headline">¶</a></h3>
<p>This function behaves like the standard python builtin <code class="docutils literal notranslate"><span class="pre">map()</span></code> except it enables distribution of calculations across CPUs.  The demo script shown below calculates a small number of prime numbers by splitting chunks of numbers across the provided cores. The key line is</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">PRIMES</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument, <code class="docutils literal notranslate"><span class="pre">is_prime</span></code>, is the function to be called with values from the data, <code class="docutils literal notranslate"><span class="pre">PRIMES</span></code>. The <code class="docutils literal notranslate"><span class="pre">max_workers</span></code> argument indicates how many worker processes to use. The elements of <code class="docutils literal notranslate"><span class="pre">PRIMES</span></code> will be broken into <code class="docutils literal notranslate"><span class="pre">max_workers</span></code> number of equal sized chunks. Each such chunk is applied to <code class="docutils literal notranslate"><span class="pre">is_prime</span></code> on a separate CPU. In this case, the returned results will be a series of <code class="docutils literal notranslate"><span class="pre">bool</span></code> values.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you don’t specify <code class="docutils literal notranslate"><span class="pre">max_workers</span></code>, all available CPUs will be used.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">cogent3.util</span> <span class="kn">import</span> <span class="n">parallel</span>


<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rank: </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">sqrt_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sqrt_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="n">PRIMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">112582705942171</span><span class="p">,</span>
    <span class="mi">112272535095293</span><span class="p">,</span>
    <span class="mi">115280095190773</span><span class="p">,</span>
    <span class="mi">115797848077099</span><span class="p">,</span>
    <span class="mi">117450548693743</span><span class="p">,</span>
    <span class="mi">993960000099397</span><span class="p">,</span>
<span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="c1"># multiplying just to increase the amount of data to calculate </span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;World size: </span><span class="si">{</span><span class="n">parallel</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">PRIMES</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="parallel-computation-on-multiple-computers">
<h2>Parallel computation on multiple computers<a class="headerlink" href="#parallel-computation-on-multiple-computers" title="Permalink to this headline">¶</a></h2>
<p>On systems consisting of multiple separate computers, we use the <a class="reference external" href="https://mpi4py.readthedocs.io/">mpi4py</a> bindings to the message passing interface (MPI) standard. Specifically, <code class="docutils literal notranslate"><span class="pre">cogent3.util.parallel.map(...,</span> <span class="pre">use_mpi=True,</span> <span class="pre">...)</span></code> uses the <a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/mpi4py.futures.html">mpi4py futures</a> module of <a class="reference external" href="https://mpi4py.readthedocs.io/">mpi4py</a>. This module is modelled after that of <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code> but using it has some important differences.</p>
<p>First, you must install additional software. You will need to install a tool implementing the MPI system (e.g. <a class="reference external" href="https://www.open-mpi.org/">openmpi</a>) and the MPI python bindings library <code class="docutils literal notranslate"><span class="pre">mpi4py</span></code>. To install <code class="docutils literal notranslate"><span class="pre">openmpi</span></code>, you can use conda, homebrew or your preferred package manager. You can just pip install <code class="docutils literal notranslate"><span class="pre">mpi4py</span></code>.</p>
<p>Second, as described in the documentation on <a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/mpi4py.futures.html">mpi4py futures</a>, you need to write your code slightly differently. We provide an example that runs on a supercomputer. To execute a program on this facility, we submit a “job” to a “queuing system” (e.g. <a class="reference external" href="https://en.wikipedia.org/wiki/Portable_Batch_System">PBS</a>) which controls the scheduling of our job with the computing resources we requested (how many CPUs, how much RAM, etc..). There are many such job control systems and the specifics of how to select the resources your job needs can vary between them. In general, however, our experience is the user writes two scripts.</p>
<ol class="arabic simple">
<li><p>a script performing the computations you actually care about</p></li>
<li><p>a bash script for the queuing system setting out the job parameters and invoking (1)</p></li>
</ol>
<p>The example code presented below is based on the <code class="docutils literal notranslate"><span class="pre">mpi4py</span></code> demo script for computing prime numbers. In addition to validating the prime numbers, it also prints out the “MPI rank” of the processor <a class="footnote-reference brackets" href="#id4" id="id1">1</a>. The script relies on the environment variable, <code class="docutils literal notranslate"><span class="pre">PBS_NCPUS</span></code> <a class="footnote-reference brackets" href="#id5" id="id2">2</a>, to establish the number of CPUs that are available. It prints to stdout, the rank of each processor <a class="footnote-reference brackets" href="#id6" id="id3">3</a>.</p>
<p>To execute this script as part of a PBS job script you need to use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mpiexec -n $PBS_NCPUS python3 -m mpi4py.futures demo-mpi-parallel.py
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To execute it directly with 4 CPUs do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ PBS_NCPUS=4 mpiexec -n 4 python3 -m mpi4py.futures demo-mpi-parallel.py
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-n</span></code> argument tells <code class="docutils literal notranslate"><span class="pre">mpiexec</span></code> to use this number of CPUs.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">demo-mpi-parallel.py</span></code> script, the key line is</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">PRIMES</span><span class="p">,</span> <span class="n">use_mpi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">PBS_CPUS</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">use_mpi</span></code> argument invokes the correct back end, otherwise the interface is the same as described above.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">mpi</span></code> for parallel execution on a single computer. This can be useful for checking your code prior to migrating to a larger system.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">cogent3.util</span> <span class="kn">import</span> <span class="n">parallel</span>


<span class="c1"># the following environment variable is created by PBS on job execution</span>
<span class="n">PBS_NCPUS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PBS_NCPUS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="k">if</span> <span class="n">PBS_NCPUS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;did not get cpu number from environment&quot;</span><span class="p">)</span>

<span class="n">PBS_NCPUS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">PBS_NCPUS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="c1"># Postprocess the processor MPI rank to check your job got the resources</span>
    <span class="c1"># you requested</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MPI Rank: </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">sqrt_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sqrt_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Each worker will evaluate 20 prime numbers. This is just to slow the</span>
    <span class="c1"># script down!</span>
    <span class="n">PRIMES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span>
            <span class="mi">112272535095293</span><span class="p">,</span>
            <span class="mi">112582705942171</span><span class="p">,</span>
            <span class="mi">112272535095293</span><span class="p">,</span>
            <span class="mi">115280095190773</span><span class="p">,</span>
            <span class="mi">115797848077099</span><span class="p">,</span>
            <span class="mi">117450548693743</span><span class="p">,</span>
            <span class="mi">993960000099397</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="o">*</span> <span class="n">PBS_NCPUS</span>
        <span class="o">*</span> <span class="mi">20</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MPI World size: </span><span class="si">{</span><span class="n">parallel</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">parallel</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">is_prime</span><span class="p">,</span> <span class="n">PRIMES</span><span class="p">,</span> <span class="n">use_mpi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="n">PBS_NCPUS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">PRIMES</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; failed</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># This block is crucial! See</span>
    <span class="c1"># https://mpi4py.readthedocs.io/en/stable/mpi4py.futures.html</span>
    <span class="c1"># for why it needs to be done</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>On MPI, the main process has rank 0, all others have rank &gt; 0.</p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>This environment variable is created by the PBS system on executing the job script.</p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>You can check your execution of the script is correct by validating you get all the ranks up to one minus the number of CPUs you requested.</p>
</dd>
</dl>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2020-2023, cogent3 Team.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>